<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Daily Inspiration â€” Multiâ€‘Category PWA</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#f57c00">
<style>
  :root {
    --bg1:#ffecd2; --bg2:#fcb69f; --card:rgba(255,255,255,0.96);
    --accent:#f57c00; --muted:#6b6b6b; --glass:rgba(255,255,255,0.6); --radius:16px;
    font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;
  }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%;margin:0;padding:0;display:block;width:100%;max-width:100vw;overflow-x:hidden;background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased;color:#222;}

  .app{width:100%;max-width:720px;margin:0 auto;padding:16px;display:flex;flex-direction:column;gap:18px;}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,#fff,#fee9d6);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);box-shadow:0 8px 22px rgba(0,0,0,0.08);backdrop-filter:saturate(180%) blur(8px);}
  h1{font-size:1.15rem;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:0.95rem}

  .card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:0 10px 32px rgba(0,0,0,0.08)}

  /* Categories: horizontally scrollable on mobile */
  .categories{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px; -webkit-overflow-scrolling:touch; scrollbar-width:none; scroll-snap-type:x mandatory}
  .categories::-webkit-scrollbar{display:none}
  .cat{color:#222;background:rgba(245,124,0,0.12);padding:8px 12px;border-radius:12px;cursor:pointer;border:1px solid rgba(245,124,0,0.12);font-weight:600;scroll-snap-align:start}
  .cat.active{background:#fff;border-color:rgba(0,0,0,0.08);box-shadow:0 8px 18px rgba(0,0,0,0.06)}

  .quote-area{display:flex;flex-direction:column;gap:12px}
  .quote-box{padding:26px;border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,0.99),rgba(255,255,255,0.94));box-shadow:0 6px 22px rgba(0,0,0,0.06);max-height:60vh;overflow:auto}

  .quote-text{font-size:1.45rem;line-height:1.65;margin:0;transition:opacity .28s ease,transform .28s ease}
  .author{font-weight:700;color:var(--muted);text-align:right;margin-top:8px;transition:opacity .28s ease,transform .28s ease}

  /* entrance state for animation */
  .enter{opacity:0;transform:translateY(8px)}

  .controls,.favorites{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center}
  button{background:var(--accent);color:white;border:none;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700}
  .btn-ghost{background:transparent;color:var(--accent);border:2px solid rgba(255,255,255,0.5);}
  .small{padding:10px 12px;font-size:1rem;border-radius:12px}
  .meta{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .fav-list{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .chip{background:#fff;padding:8px 12px;border-radius:12px;border:1px solid rgba(0,0,0,0.04);font-size:0.95rem;cursor:pointer}
  .fav-active{filter:drop-shadow(0 2px 6px rgba(0,0,0,0.12));}

  /* Splash */
  #splash{position:fixed;width:100%;height:100%;background:linear-gradient(to right,#ffecd2,#fcb69f);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;opacity:1;transition:opacity 400ms ease,transform 400ms ease;}
  #splash img{width:120px;height:120px;margin-bottom:18px;border-radius:50% !important;overflow:hidden;box-shadow:0 8px 22px rgba(0,0,0,0.12);}
  #splash h1{font-size:2rem;color:#fff;text-shadow:1px 1px 6px rgba(0,0,0,0.2)}
  .hidden-splash{opacity:0;transform:scale(1.03);pointer-events:none}

  /* Floating next button for mobile */
  #btn-float-next,#btn-float-prev{position:fixed;bottom:calc(20px + env(safe-area-inset-bottom));padding:14px 18px;border-radius:50px;background:var(--accent);color:#fff;font-weight:800;border:none;box-shadow:0 8px 26px rgba(0,0,0,0.16);z-index:999}
  #btn-float-next{right:20px}
  #btn-float-prev{left:20px}

  /* smaller screens */
  @media (max-width:600px){
    .app{padding:16px}
    .logo{width:48px;height:48px}
    .quote-text{font-size:1.15rem;line-height:1.55}
    .author{font-size:1rem}
    .card{padding:18px}
    .quote-box{padding:18px;border-radius:14px}
    button.small{padding:12px 14px;font-size:0.98rem}
    /* show float on mobile */
    #btn-float-next,#btn-float-prev{display:block}
  }
  @media (min-width:601px){
    #btn-float-next,#btn-float-prev{display:none}
  }

  /* accessibility focus */
  .cat:focus, button:focus, .chip:focus{outline:3px solid rgba(245,124,0,0.18);outline-offset:3px}

  footer{margin-top:8px;color:var(--muted);font-size:0.9rem;text-align:center}
</style>
</head>
<body>

<div id="splash" role="status" aria-live="polite">
  <img src="icon-512.png" alt="App Icon">
  <h1>Daily Inspiration</h1>
</div>

<main class="app" role="main">
  <header>
    <div class="brand">
      <div class="logo">DI</div>
      <div>
        <h1>Daily Inspiration</h1>
        <p class="lead">Choose a category. Save favorites. Daily reminders.</p>
      </div>
    </div>
    <div class="header-controls">
      <button id="btn-share-image" class="small" title="Share image">Share Quote</button>
      <button id="btn-notify" class="small" aria-pressed="false">Enable Notification</button>
    </div>
  </header>

  <section class="card">
    <div class="categories" id="categories" role="tablist" aria-label="Categories"></div>
    <div class="quote-area">
      <div id="quote-box" class="quote-box" aria-live="polite">
        <p id="quote" class="quote-text">Loadingâ€¦</p>
        <p id="author" class="author"></p>
      </div>

        <div id="progress" style="font-size:0.9rem;color:var(--muted)">0 / 0</div>
      </div>
    </div>
  </section>

  <footer>
    &copy; Francis Otieno
  </footer>
</main>

<button id="btn-float-next" aria-label="Next Quote">Next</button>
<button id="btn-float-prev" aria-label="Previous Quote">Prev</button>

<script>
const DB = {}, state = { categories: [], active: null, pool: [], index: 0, random: false };
const qs = s => document.querySelector(s), qsa = s => Array.from(document.querySelectorAll(s));
const LS = {
  get: (k, fallback) => {
    try {
      const v = localStorage.getItem(k);
      return v === null ? fallback : JSON.parse(v);
    } catch (e) { return fallback; }
  },
  set: (k, v) => {
    try { localStorage.setItem(k, JSON.stringify(v)); }
    catch (e) { /* ignore */ }
  }
};

let autoMode = false, autoInterval = null;

// Elements we expect (guarded usage)
const quoteEl = qs('#quote'), authorEl = qs('#author'), progressEl = qs('#progress');
const categoriesEl = qs('#categories');

// utility
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    let j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

// --- fetch quotes.json with fallback ---
(async function loadQuotes(){
  try{
    const r = await fetch('quotes.json');
    if(!r.ok) throw new Error('fetch failed');
    const data = await r.json();
    Object.assign(DB, data);
  }catch(e){
    console.warn('quotes load failed', e);
    DB['General'] = [{ text: 'Welcome â€” add quotes.json to get started', author: 'App' }];
  } finally {
    state.categories = Object.keys(DB);
    initApp();
  }
})();

// Build categories as accessible tabs
function buildCategories(){
  if(!categoriesEl) return;
  categoriesEl.innerHTML = '';
  state.categories.forEach((cat, i) => {
    const btn = document.createElement('button');
    btn.className = 'cat';
    btn.textContent = cat;
    btn.setAttribute('role', 'tab');
    btn.setAttribute('aria-selected', 'false');
    btn.setAttribute('tabindex', i === 0 ? '0' : '-1'); // only first is in tab order initially
    btn.id = `tab-${i}`;
    btn.setAttribute('aria-controls', 'quote-box');
    btn.addEventListener('click', () => selectCategory(cat));
    btn.addEventListener('keydown', (e) => {
      // Arrow navigation between categories
      if(e.key === 'ArrowRight' || e.key === 'ArrowLeft' || e.key === 'Home' || e.key === 'End'){
        e.preventDefault();
        const all = qsa('.cat');
        const idx = all.indexOf(btn);
        let nextIdx = idx;
        if(e.key === 'ArrowRight') nextIdx = (idx + 1) % all.length;
        if(e.key === 'ArrowLeft') nextIdx = (idx - 1 + all.length) % all.length;
        if(e.key === 'Home') nextIdx = 0;
        if(e.key === 'End') nextIdx = all.length - 1;
        all[nextIdx].focus();
        all[nextIdx].click();
      } else if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        selectCategory(cat);
      }
    });
    categoriesEl.appendChild(btn);
  });
}

// Select a category and prepare pool
function selectCategory(cat){
  state.active = cat;
  state.pool = Array.isArray(DB[cat]) ? [...DB[cat]] : [];
  if(state.pool.length === 0){
    state.index = 0;
    renderEmpty();
    updateCategoryUI();
    LS.set('lastCategory', cat);
    return;
  }
  if(state.random) shuffle(state.pool);
  state.index = 0;
  // show first item immediately (consistent)
  displayCurrent(true);
  updateCategoryUI();
  LS.set('lastCategory', cat);
}

function renderEmpty(){
  if(quoteEl) quoteEl.textContent = 'No items in this category.';
  if(authorEl) authorEl.textContent = '';
  if(progressEl) progressEl.textContent = '0 / 0';
}

function updateCategoryUI(){
  // update active class and aria-selected
  qsa('.cat').forEach(el => {
    const isActive = el.textContent === state.active;
    el.classList.toggle('active', isActive);
    el.setAttribute('aria-selected', isActive ? 'true' : 'false');
    el.setAttribute('tabindex', isActive ? '0' : '-1');
  });

  const total = state.pool.length;
  // Human-friendly current index: show 1-based index if there's at least one item.
  const current = total === 0 ? 0 : Math.min(state.index, total); // state.index points to next to show in showNext; displayCurrent uses displayedIndex
  if(progressEl) {
    // compute displayed index: if we have previously displayed item, attempt to show that 1-based position
    // we'll store lastDisplayedIndex as last shown position (1-based) on state for accurate progress
    const displayed = state.lastDisplayedIndex ?? (total === 0 ? 0 : 1);
    progressEl.textContent = `${displayed} / ${total}`;
  }
  // update notification button state if present
  const btnNotify = qs('#btn-notify');
  if(btnNotify) {
    if(LS.get('notifications', false) && Notification.permission === 'granted'){
      btnNotify.textContent = 'ðŸ”” On';
      btnNotify.setAttribute('aria-pressed', 'true');
    } else {
      btnNotify.setAttribute('aria-pressed', 'false');
    }
  }
}

// Show the currently indexed item (used after setting state.index)
function displayCurrent(skipFade = false){
  if(!state.pool || state.pool.length === 0) return renderEmpty();
  // state.index is 0-based and points to next item to show in showNext flow.
  // For displayCurrent, if state.index === 0, we want pool[0].
  const idxToShow = (state.index % state.pool.length + state.pool.length) % state.pool.length;
  const item = state.pool[idxToShow];
  // remember displayed index for progress
  state.lastDisplayedIndex = idxToShow + 1;

  if(!skipFade && quoteEl && authorEl){
    quoteEl.classList.add('enter'); authorEl.classList.add('enter');
    setTimeout(() => {
      quoteEl.textContent = item.text;
      authorEl.textContent = item.author ? `â€” ${item.author}` : '';
      // trigger reflow for animation
      void quoteEl.offsetWidth;
      quoteEl.classList.remove('enter'); authorEl.classList.remove('enter');
      updateCategoryUI();
    }, 120);
  } else {
    if(quoteEl) quoteEl.textContent = item.text;
    if(authorEl) authorEl.textContent = item.author ? `â€” ${item.author}` : '';
    updateCategoryUI();
  }
}

// Advance to next item (wraps)
function showNext(skipFade = false){
  if(!state.pool || state.pool.length === 0) return renderEmpty();
  // show current then increment index for next time
  displayCurrent(skipFade);
  state.index = (state.index + 1) % state.pool.length;
  // after showing, update lastDisplayedIndex already set in displayCurrent
  updateCategoryUI();
}

// Show previous item (wrap backwards)
function showPrevious(skipFade = false){
  if(!state.pool || state.pool.length === 0) return renderEmpty();
  // decrement index to point to previous item, then display it
  // Because state.index points to the "next to show" in normal flow, previous is:
  state.index = (state.index - 1 + state.pool.length) % state.pool.length;
  displayCurrent(skipFade);
  // increment index so that subsequent showNext continues forward from the item after the displayed one
  state.index = (state.index + 1) % state.pool.length;
  updateCategoryUI();
}

// Text wrapping for canvas
function wrapText(ctx, text, x, y, maxWidth, lineHeight){
  const words = text.split(' ');
  let line = '', lines = [];
  for(let n = 0; n < words.length; n++){
    const testLine = line + words[n] + ' ';
    if(ctx.measureText(testLine).width > maxWidth && n > 0){
      lines.push(line.trim());
      line = words[n] + ' ';
    } else {
      line = testLine;
    }
  }
  if(line) lines.push(line.trim());
  lines.forEach((l, i) => ctx.fillText(l, x, y + (i * lineHeight)));
}

// Share quote as an image (graceful fallback)
function shareQuoteImage(){
  if(!quoteEl) return;
  const text = quoteEl.textContent || '';
  const author = (authorEl ? authorEl.textContent.replace(/^â€”\s?/, '') : '') || '';
  const canvas = document.createElement('canvas');
  canvas.width = 1200; canvas.height = 675;
  const ctx = canvas.getContext('2d');
  // gradient background
  const grad = ctx.createLinearGradient(0,0,canvas.width,canvas.height);
  grad.addColorStop(0,'#ffecd2'); grad.addColorStop(1,'#fcb69f');
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // text (attempt to use Inter - will fallback to sans-serif)
  ctx.fillStyle = '#222';
  ctx.textAlign = 'center';
  ctx.font = 'bold 40px Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
  wrapText(ctx, text, canvas.width/2, 180, 1000, 56);
  if(author){
    ctx.font = 'italic 30px Inter, system-ui, sans-serif';
    ctx.fillText(`â€” ${author}`, canvas.width/2, 520);
  }

  canvas.toBlob(async blob => {
    if(!blob) return;
    try {
      const file = new File([blob], 'quote.png', { type: 'image/png' });
      if(navigator.canShare && navigator.canShare({ files: [file] })){
        await navigator.share({ files: [file], title: 'Daily Inspiration' }).catch(()=>{});
      } else {
        // download fallback
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'quote.png';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
    } catch (e) {
      // older browsers: fallback to data URL download
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url;
      a.download = 'quote.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }
  });
}

// Notifications
function enableNotifications(){
  if(!('Notification' in window)){ alert('Not supported'); return; }
  Notification.requestPermission().then(p => {
    if(p === 'granted'){ LS.set('notifications', true); scheduleDailyNotification(); const btn = qs('#btn-notify'); if(btn) { btn.textContent = 'ðŸ”” On'; btn.setAttribute('aria-pressed','true'); } }
    else alert('Notifications denied');
  });
}

let _notifyTimeoutId = null;
function scheduleDailyNotification(hour = 9){
  // clear previous timeout/interval
  if(_notifyTimeoutId) { clearTimeout(_notifyTimeoutId); _notifyTimeoutId = null; }
  // time until next target hour (local)
  const now = new Date();
  let target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, 0, 0, 0);
  if(now >= target) target.setDate(target.getDate() + 1);
  const msToNext = target - now;
  _notifyTimeoutId = setTimeout(() => {
    sendDailyNotification();
    // subsequent notifications every 24h
    _notifyTimeoutId = setInterval(sendDailyNotification, 24 * 60 * 60 * 1000);
  }, msToNext);
}

function sendDailyNotification(){
  const cat = LS.get('lastCategory', state.categories[0] || 'General');
  const items = DB[cat] || [];
  if(!items.length) return;
  const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(),0,0)) / 1000 / 60 / 60 / 24);
  const item = items[dayOfYear % items.length];
  const body = item.text + (item.author ? ` â€” ${item.author}` : '');
  if('serviceWorker' in navigator && navigator.serviceWorker.controller){
    navigator.serviceWorker.controller.postMessage({ type: 'show-notification', title: 'Daily Inspiration', body });
  } else if(Notification.permission === 'granted'){
    new Notification('Daily Inspiration', { body });
  }
}

// --- Swipe gestures for mobile ---
let touchStartX = 0, touchEndX = 0;
const swipeThreshold = 50;
const touchTarget = qs('#quote-box');
if(touchTarget){
  touchTarget.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
  touchTarget.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); }, { passive: true });
}
function handleSwipe(){
  const dx = touchEndX - touchStartX;
  if(Math.abs(dx) > swipeThreshold){
    if(dx < 0) showNext();
    else showPrevious();
  }
}

// --- Initialization ---
function initApp(){
  // build UI
  buildCategories();

  // wire up core buttons (if present)
  const btnNext = qs('#btn-float-next');
  const btnPrev = qs('#btn-float-prev');
  const btnShare = qs('#btn-share-image');
  const btnNotify = qs('#btn-notify');

  if(btnNext) btnNext.addEventListener('click', () => showNext(false));
  if(btnPrev) btnPrev.addEventListener('click', () => showPrevious(false));
  if(btnShare) btnShare.addEventListener('click', shareQuoteImage);
  if(btnNotify) btnNotify.addEventListener('click', enableNotifications);

  // keyboard shortcuts
  document.addEventListener('keydown', e => {
    // don't hijack when typing in inputs, etc.
    const activeIsInput = ['INPUT','TEXTAREA'].includes(document.activeElement.tagName);
    if(activeIsInput) return;
    if(e.key === ' '){
      e.preventDefault();
      showNext();
    } else if(e.key === 's'){
      // use existing share function
      shareQuoteImage();
    } else if(e.key === 'ArrowRight'){
      showNext();
    } else if(e.key === 'ArrowLeft'){
      showPrevious();
    }
  });

  // restore UI state: random toggle (if you add a UI element for it later)
  const persistedRandom = LS.get('random', false);
  state.random = !!persistedRandom;

  // restore last category (if present), else pick first available
  const persistedLast = LS.get('lastCategory', null);
  const lastToUse = (persistedLast && state.categories.includes(persistedLast)) ? persistedLast : (state.categories[0] || 'General');
  if(lastToUse) selectCategory(lastToUse);

  // splash hide
  const splash = qs('#splash');
  if(splash){
    requestAnimationFrame(()=> splash.classList.add('hidden-splash'));
    splash.addEventListener('transitionend', () => { try { splash.remove(); } catch (e) {} });
  }

  // service worker
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./service-worker.js').catch(e => console.warn('SW failed', e));
  }

  // schedule notification if previously enabled
  if(LS.get('notifications', false) && Notification.permission === 'granted'){
    scheduleDailyNotification();
    if(btnNotify){ btnNotify.textContent = 'ðŸ”” On'; btnNotify.setAttribute('aria-pressed','true'); }
  }
}

</script>

</body>
</html>











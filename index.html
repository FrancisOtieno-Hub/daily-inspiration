<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Daily Inspiration ‚Äî Multi‚ÄëCategory PWA</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#f57c00">
<style>
  :root {
    --bg1:#ffecd2; --bg2:#fcb69f; --card:rgba(255,255,255,0.96);
    --accent:#f57c00; --muted:#6b6b6b; --glass:rgba(255,255,255,0.6); --radius:16px;
    font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;
  }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%;margin:0;display:flex;align-items:center;justify-content:center;padding:env(safe-area-inset-top,20px) env(safe-area-inset-right,20px) env(safe-area-inset-bottom,20px) env(safe-area-inset-left,20px);
  background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased;color:#222;}

  .app{width:100%;max-width:900px;padding:24px;display:flex;flex-direction:column;gap:18px;}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(180deg,#fff,#fee9d6);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent);box-shadow:0 8px 22px rgba(0,0,0,0.08)}
  h1{font-size:1.15rem;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:0.95rem}

  .card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:0 10px 32px rgba(0,0,0,0.08)}

  /* Categories: horizontally scrollable on mobile */
  .categories{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px; -webkit-overflow-scrolling:touch; scrollbar-width:none}
  .categories::-webkit-scrollbar{display:none}
  .cat{color:#222;background:var(--glass);padding:8px 12px;border-radius:12px;cursor:pointer;border:1px solid rgba(0,0,0,0.04);font-weight:600;white-space:nowrap}
  .cat.active{background:#fff;border-color:rgba(0,0,0,0.08);box-shadow:0 8px 18px rgba(0,0,0,0.06)}

  .quote-area{display:flex;flex-direction:column;gap:12px}
  .quote-box{padding:26px;border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,0.99),rgba(255,255,255,0.94));box-shadow:0 6px 22px rgba(0,0,0,0.06);max-height:60vh;overflow:auto}

  .quote-text{font-size:1.45rem;line-height:1.45;margin:0;transition:opacity .28s ease,transform .28s ease}
  .author{font-weight:700;color:var(--muted);text-align:right;margin-top:8px;transition:opacity .28s ease,transform .28s ease}

  /* entrance state for animation */
  .enter{opacity:0;transform:translateY(8px)}

  .controls,.favorites{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center}
  button{background:var(--accent);color:white;border:none;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:700}
  .btn-ghost{background:transparent;color:var(--accent);border:2px solid rgba(255,255,255,0.5);}
  .small{padding:10px 12px;font-size:1rem;border-radius:12px}
  .meta{display:flex;gap:12px;align-items:center;justify-content:space-between}
  .fav-list{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
  .chip{background:#fff;padding:8px 12px;border-radius:12px;border:1px solid rgba(0,0,0,0.04);font-size:0.95rem;cursor:pointer}

  /* Splash */
  #splash{position:fixed;left:0;top:0;width:100%;height:100%;background:linear-gradient(to right,#ffecd2,#fcb69f);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;opacity:1;transition:opacity 600ms ease,transform 600ms ease}
  #splash img{width:120px;height:120px;margin-bottom:18px}
  #splash h1{font-size:2rem;color:#fff;text-shadow:1px 1px 6px rgba(0,0,0,0.2)}
  .hidden-splash{opacity:0;transform:scale(1.05)}

  /* Floating next button for mobile */
  #btn-float-next{position:fixed;bottom:calc(20px + env(safe-area-inset-bottom));right:20px;padding:14px 18px;border-radius:50px;background:var(--accent);color:#fff;font-weight:800;border:none;box-shadow:0 8px 26px rgba(0,0,0,0.16);z-index:999}

  /* smaller screens */
  @media (max-width:600px){
    .app{padding:16px}
    .logo{width:48px;height:48px}
    .quote-text{font-size:1.15rem;line-height:1.55}
    .author{font-size:1rem}
    .card{padding:18px}
    .quote-box{padding:18px;border-radius:14px}
    button.small{padding:12px 14px;font-size:0.98rem}
    /* hide float on wide screens */
    #btn-float-next{display:block}
  }
  @media (min-width:601px){
    #btn-float-next{display:none}
  }

  /* accessibility focus */
  .cat:focus, button:focus, .chip:focus{outline:3px solid rgba(245,124,0,0.18);outline-offset:3px}

  footer{margin-top:8px;color:var(--muted);font-size:0.9rem;text-align:center}
</style>
</head>
<body>

<div id="splash">
  <img src="icon-512.png" alt="App Icon">
  <h1>Daily Inspiration</h1>
</div>

<main class="app" role="main">
  <header>
    <div class="brand">
      <div class="logo">DI</div>
      <div>
        <h1>Daily Inspiration</h1>
        <p class="lead">Choose a category. Save favorites. Daily reminders.</p>
      </div>
    </div>
    <div class="header-controls">
      <button id="btn-share" class="small" title="Share current">üì§ Share</button>
      <button id="btn-notify" class="small">üîî Notify</button>
    </div>
  </header>

  <section class="card">
    <div class="categories" id="categories" role="tablist" aria-label="Categories"></div>
    <div class="quote-area">
      <div id="quote-box" class="quote-box" aria-live="polite">
        <p id="quote" class="quote-text">Loading‚Ä¶</p>
        <p id="author" class="author"></p>
      </div>

      <div class="meta">
        <div class="favorites">
          <button id="btn-prev" class="small btn-ghost" aria-label="Previous Quote">‚óÄ Prev</button>
          <button id="btn-next" class="small btn-ghost" aria-label="Next Quote">Next ‚ñ∂</button>
          <button id="btn-fav" class="small" aria-label="Favorite Quote">‚òÖ Favorite</button>
        </div>
        <div id="progress" style="font-size:0.9rem;color:var(--muted)">0 / 0</div>
      </div>

      <div class="controls">
        <button id="btn-export" class="small">Export</button>
        <button id="btn-auto" class="small btn-ghost">Auto Off</button>
        <button id="btn-share-img" class="small btn-ghost">üñºÔ∏è Image</button>
      </div>

      <div id="favorites-panel" style="display:none;margin-top:10px;">
        <div style="font-weight:700;margin-bottom:8px">Favorites</div>
        <div class="fav-list" id="fav-list"></div>
      </div>
    </div>
  </section>

  <footer>
    &copy; Francis Otieno
  </footer>
</main>

<button id="btn-float-next" aria-label="Next Quote">Next</button>

<script>
const DB = {}, state = { categories: [], active: null, pool: [], index: 0 };
let autoMode=false, autoInterval;

const qs=s=>document.querySelector(s), qsa=s=>Array.from(document.querySelectorAll(s));
const LS={get:(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch(e){return f}}, set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};

fetch('quotes.json').then(r=>r.json()).then(data=>{Object.assign(DB,data);state.categories=Object.keys(DB);initApp();}).catch(e=>{console.warn('quotes load failed',e);state.categories=['General'];DB['General']=[{text:'Welcome ‚Äî add quotes.json to get started',author:'App'}];initApp();});

const quoteEl=qs('#quote'), authorEl=qs('#author'), progressEl=qs('#progress');
const categoriesEl=qs('#categories'), favPanel=qs('#favorites-panel'), favList=qs('#fav-list');

function shuffle(arr){for(let i=arr.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}}

function buildCategories(){
  categoriesEl.innerHTML='';
  state.categories.forEach(cat=>{
    const btn=document.createElement('button');
    btn.className='cat';
    btn.textContent=cat;
    btn.setAttribute('role','tab');
    btn.setAttribute('aria-selected','false');
    btn.onclick=()=>selectCategory(cat);
    categoriesEl.appendChild(btn);
  });
}

function selectCategory(cat){
  state.active=cat; state.pool=[...(DB[cat]||[])]; shuffle(state.pool); state.index=0;
  updateCategoryUI(); showNext(true); LS.set('lastCategory',cat);
}

function updateCategoryUI(){
  qsa('.cat').forEach(el=>{
    el.classList.toggle('active',el.textContent===state.active);
    el.setAttribute('aria-selected',el.textContent===state.active?'true':'false');
  });
  progressEl.textContent=`${Math.min(state.index,state.pool.length)} / ${state.pool.length}`;
}

function showNext(skipFade=false){
  if(!state.pool || state.pool.length===0){
    quoteEl.textContent='No items in this category.'; authorEl.textContent=''; progressEl.textContent='0 / 0'; return;
  }
  if(state.index>=state.pool.length) state.index=0;
  const item=state.pool[state.index++];
  displayQuote(item, skipFade);
}

function showPrevious(skipFade=false){
  if(!state.pool || state.pool.length===0){quoteEl.textContent='No items in this category.'; authorEl.textContent=''; progressEl.textContent='0 / 0'; return;}
  state.index--; if(state.index<0) state.index=state.pool.length-1;
  const item=state.pool[state.index];
  displayQuote(item, skipFade);
}

function displayQuote(item, skipFade){
  // entrance animation: add enter state, then update text and remove enter to animate in
  if(!skipFade){
    quoteEl.classList.add('enter'); authorEl.classList.add('enter');
    setTimeout(()=>{
      quoteEl.textContent=item.text;
      authorEl.textContent=item.author?`‚Äî ${item.author}`:'';
      // force reflow before removing class for a smoother animation
      void quoteEl.offsetWidth;
      quoteEl.classList.remove('enter'); authorEl.classList.remove('enter');
      updateCategoryUI();
    },120);
  } else {
    quoteEl.textContent=item.text; authorEl.textContent=item.author?`‚Äî ${item.author}`:''; updateCategoryUI();
  }
}

function getFavorites(){return LS.get('favorites',[]);} 
function toggleFavorite(){
  const cur={text:quoteEl.textContent,author:authorEl.textContent.replace(/^‚Äî\s?/,'') ,category:state.active};
  const favs=getFavorites();
  const idx=favs.findIndex(f=>f.text===cur.text&&f.author===cur.author);
  idx>=0?favs.splice(idx,1):favs.unshift(cur);
  LS.set('favorites',favs); renderFavorites();
}
function renderFavorites(){
  const favs=getFavorites(); favList.innerHTML='';
  if(!favs.length){favPanel.style.display='none'; return;}
  favPanel.style.display='block';
  favs.forEach(f=>{
    const chip=document.createElement('div');
    chip.className='chip';
    chip.textContent=f.text.length>80?f.text.slice(0,80)+'‚Ä¶':f.text;
    chip.title=(f.author?f.author+': ':'')+f.text;
    chip.onclick=()=>{quoteEl.textContent=f.text;authorEl.textContent=f.author?`‚Äî ${f.author}`:'';updateCategoryUI();};
    favList.appendChild(chip);
  });
}

function shareCurrent(){
  const text=quoteEl.textContent+(authorEl.textContent?' '+authorEl.textContent:'');
  if(navigator.share){navigator.share({text,title:'Daily Inspiration'}).catch(()=>{});} 
  else if(navigator.clipboard){navigator.clipboard.writeText(text).then(()=>alert('Copied!')).catch(()=>alert('Could not copy'));} 
  else prompt('Copy the quote:',text);
}

function exportFavorites(){
  const favs=getFavorites();
  if(!favs.length){alert('No favorites to export.');return;}
  const blob=new Blob([favs.map(f=>`"${f.text.replace(/\"/g,'\\\"')}" ‚Äî ${f.author}`).join('\n\n')],{type:'text/plain'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='favorites.txt'; a.click(); URL.revokeObjectURL(url);
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight){
  const words=text.split(' '); let line='', lines=[];
  for(let n=0;n<words.length;n++){
    const testLine=line+words[n]+' ';
    if(ctx.measureText(testLine).width>maxWidth&&n>0){lines.push(line); line=words[n]+' ';} else {line=testLine;}
  }
  lines.push(line); lines.forEach((l,i)=>ctx.fillText(l,x,y+(i*lineHeight)));
}

function shareQuoteImage(){
  const text=quoteEl.textContent, author=authorEl.textContent.replace(/^‚Äî\s?/,'');
  const canvas=document.createElement('canvas'); canvas.width=1200; canvas.height=675;
  const ctx=canvas.getContext('2d');
  const grad=ctx.createLinearGradient(0,0,canvas.width,canvas.height); grad.addColorStop(0,'#ffecd2'); grad.addColorStop(1,'#fcb69f'); ctx.fillStyle=grad; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#222'; ctx.textAlign='center'; ctx.font='bold 40px Inter, sans-serif';
  wrapText(ctx,text,canvas.width/2,200,1000,56);
  if(author){ctx.font='italic 30px Inter, sans-serif'; ctx.fillText(`‚Äî ${author}`,canvas.width/2,520);}
  canvas.toBlob(async blob=>{
    if(navigator.canShare && navigator.canShare({files:[new File([blob],'quote.png',{type:'image/png'})]})){
      navigator.share({files:[new File([blob],'quote.png',{type:'image/png'})], title:'Daily Inspiration'}).catch(()=>{});
    } else {
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='quote.png'; a.click(); URL.revokeObjectURL(url);
    }
  });
}

function enableNotifications(){
  if(!('Notification' in window)){alert('Not supported'); return;}
  Notification.requestPermission().then(p=>{
    if(p==='granted'){LS.set('notifications',true); scheduleDailyNotification(); qs('#btn-notify').textContent='üîî On';}
    else alert('Notifications denied');
  });
}

function scheduleDailyNotification(){
  if(window._notifyInterval) clearInterval(window._notifyInterval);
  const msToNext=(hour=9)=>{const now=new Date(); let t=new Date(now.getFullYear(),now.getMonth(),now.getDate(),hour); if(now>t) t.setDate(t.getDate()+1); return t-now;};
  setTimeout(()=>{sendDailyNotification(); window._notifyInterval=setInterval(sendDailyNotification,24*60*60*1000);}, msToNext());
}

function sendDailyNotification(){
  const cat=LS.get('lastCategory',state.categories[0]);
  const items=DB[cat]||[]; if(!items.length) return;
  const dayOfYear=Math.floor((new Date()-new Date(new Date().getFullYear(),0,0))/1000/60/60/24);
  const item=items[dayOfYear%items.length];
  if('serviceWorker' in navigator && navigator.serviceWorker.controller){
    navigator.serviceWorker.controller.postMessage({type:'show-notification',title:'Daily Inspiration',body:item.text+(item.author?` ‚Äî ${item.author}`:'')});
  } else if(Notification.permission==='granted'){
    new Notification('Daily Inspiration',{body:item.text+(item.author?` ‚Äî ${item.author}`:'')});
  }
}

// --- Swipe gestures for mobile ---
let touchStartX = 0; let touchEndX = 0; const swipeThreshold = 50;
quoteEl.parentElement.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; });
quoteEl.parentElement.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); });
function handleSwipe(){ const dx = touchEndX - touchStartX; if (Math.abs(dx) > swipeThreshold) { if (dx < 0) showNext(); else showPrevious(); } }
  
function initApp(){
  buildCategories();
  const last=LS.get('lastCategory',state.categories[0]); selectCategory(last);
  renderFavorites();

  qs('#btn-next').onclick=()=>showNext();
  qs('#btn-prev').onclick=()=>showPrevious();
  qs('#btn-fav').onclick=toggleFavorite;
  qs('#btn-export').onclick=exportFavorites;
  qs('#btn-notify').onclick=enableNotifications;
  qs('#btn-auto').onclick=()=>{
    autoMode=!autoMode; qs('#btn-auto').textContent=autoMode?'Auto On':'Auto Off';
    if(autoMode){autoInterval=setInterval(showNext,8000);} else clearInterval(autoInterval);
  };
  qs('#btn-share').onclick=shareCurrent;
  qs('#btn-share-img').onclick=shareQuoteImage;
  qs('#btn-float-next').onclick=showNext;

  document.addEventListener('keydown',e=>{
    if(e.key===' '){e.preventDefault();showNext();}
    if(e.key==='f') toggleFavorite();
    if(e.key==='s') shareCurrent();
  });

  if(LS.get('notifications',false)&&Notification.permission==='granted'){
    qs('#btn-notify').textContent='üîî On'; scheduleDailyNotification();
  }

  if('serviceWorker' in navigator){navigator.serviceWorker.register('/service-worker.js').catch(e=>console.warn('SW failed',e));}

  let deferredPrompt;
  window.addEventListener('beforeinstallprompt',e=>{
    e.preventDefault(); deferredPrompt=e;
    const btn=document.createElement('button'); btn.textContent="Install App"; btn.className="small btn-ghost";
    btn.onclick=async()=>{ btn.remove(); deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; };
    document.querySelector('header').appendChild(btn);
  });

  // splash hide with subtle scale
  setTimeout(()=>qs('#splash').classList.add('hidden-splash'),400);
  setTimeout(()=>qs('#splash').style.display='none',1100);
}
</script>
</body>
</html>
